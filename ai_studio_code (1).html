<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Granny: Biker House Horror</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Crimson Text', serif; user-select: none; }
        
        /* SCARY UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #overlay { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, transparent 30%, black 100%); }
        
        #inventory { position: absolute; top: 20px; left: 20px; color: #ff0000; font-size: 24px; text-shadow: 2px 2px #330000; font-weight: bold; }
        
        /* LOADING SCREEN FIX */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; color: #ff0000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000; 
        }
        .bar-container { width: 200px; height: 10px; border: 1px solid #ff0000; margin-top: 10px; }
        #bar { width: 0%; height: 100%; background: #ff0000; transition: 0.1s; }

        /* JOYSTICK */
        #joystick-zone { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; pointer-events: auto; opacity: 0.6; }

        /* JUMPSCARE */
        #jumpscare { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: url('https://i.imgur.com/vHqP3wI.jpeg') center/cover; z-index: 2000; 
        }
    </style>
</head>
<body>

    <div id="loader">
        <h1>PREPARING HOUSE...</h1>
        <div class="bar-container"><div id="bar"></div></div>
    </div>

    <div id="jumpscare"></div>

    <div id="ui-layer">
        <div id="overlay"></div>
        <div id="inventory">OBJECTIVE: FIND KEY & ESCAPE</div>
    </div>

    <div id="joystick-zone"></div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>

    <script>
        /** GAME SETTINGS **/
        let scene, camera, renderer, joystick;
        let moveData = { x: 0, y: 0 };
        const walls = []; // Physics/Collision array
        let hasKey = false;
        let isGameOver = false;

        // 1. SETUP ENGINE & LOADER
        function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.15);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.7, 5); // Start position

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Flashlight
            const flashlight = new THREE.SpotLight(0xffffff, 1.5, 15, Math.PI/6, 0.5);
            camera.add(flashlight);
            flashlight.target = new THREE.Object3D();
            camera.add(flashlight.target);
            flashlight.target.position.set(0, 0, -1);
            scene.add(camera);

            buildBikerHouse();
            setupJoystick();
            spawnGranny();

            // Loader finish logic
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                animate();
            }, 2000);
        }

        // 2. BUILD THE BIKER HOUSE (Multi-Room Logic)
        function buildBikerHouse() {
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x221111 });
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x111111 });

            // Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(40, 40), floorMat);
            floor.rotation.x = -Math.PI/2;
            scene.add(floor);

            // Create Room Walls (Box Physics)
            function createWall(w, h, d, x, z) {
                const wall = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), wallMat);
                wall.position.set(x, h/2, z);
                scene.add(wall);
                walls.push(new THREE.Box3().setFromObject(wall)); // Add to physics
            }

            // Outer Perimeter
            createWall(20, 4, 1, 0, -10); // Back
            createWall(1, 4, 20, -10, 0); // Left
            createWall(1, 4, 20, 10, 0);  // Right
            
            // Inner Rooms
            createWall(8, 4, 0.5, -6, 0); // Room 1 wall
            createWall(0.5, 4, 5, 2, -7.5); // Closet

            // THE DOOR (Escape)
            const doorGeo = new THREE.BoxGeometry(2, 3, 0.2);
            const doorMat = new THREE.MeshStandardMaterial({color: 0x550000});
            window.exitDoor = new THREE.Mesh(doorGeo, doorMat);
            window.exitDoor.position.set(0, 1.5, -9.5);
            scene.add(window.exitDoor);

            // THE KEY
            const keyGeo = new THREE.SphereGeometry(0.2);
            window.keyItem = new THREE.Mesh(keyGeo, new THREE.MeshBasicMaterial({color: 0xffff00}));
            window.keyItem.position.set(-7, 0.5, -8);
            scene.add(window.keyItem);
        }

        // 3. JOYSTICK & MOVEMENT
        function setupJoystick() {
            const options = { zone: document.getElementById('joystick-zone'), mode: 'static', position: {left: '60px', bottom: '60px'}, color: 'red' };
            joystick = nipplejs.create(options);
            joystick.on('move', (e, data) => {
                moveData.x = data.vector.x;
                moveData.y = data.vector.y;
            });
            joystick.on('end', () => { moveData = {x:0, y:0}; });
        }

        // 4. GRANNY AI
        let granny;
        function spawnGranny() {
            granny = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1), new THREE.MeshStandardMaterial({color: 0xffffff}));
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshStandardMaterial({color: 0xdddddd}));
            head.position.y = 0.8;
            granny.add(body, head);
            granny.position.set(5, 1, -5);
            scene.add(granny);
        }

        // 5. PHYSICS & COLLISION SYSTEM
        function checkCollision(newPos) {
            const playerSphere = new THREE.Sphere(newPos, 0.5);
            for(let wallBox of walls) {
                if(wallBox.intersectsSphere(playerSphere)) return true;
            }
            return false;
        }

        // 6. GAME LOOP
        function animate() {
            if(isGameOver) return;
            requestAnimationFrame(animate);

            // Move Logic
            const speed = 0.08;
            const nextPos = camera.position.clone();
            
            // Apply movement based on camera look direction
            const direction = new THREE.Vector3();
            camera.getWorldDirection(direction);
            direction.y = 0; 

            if(moveData.y !== 0) {
                const step = direction.clone().multiplyScalar(moveData.y * speed);
                const testPos = camera.position.clone().add(step);
                if(!checkCollision(testPos)) camera.position.add(step);
            }
            
            // Rotation (Look)
            camera.rotation.y -= moveData.x * 0.03;

            // Granny AI Follow
            const grannyDir = new THREE.Vector3().subVectors(camera.position, granny.position).normalize();
            granny.position.addScaledVector(grannyDir, 0.025);
            granny.lookAt(camera.position.x, 1, camera.position.z);

            // Jumpscare Distance
            if(granny.position.distanceTo(camera.position) < 1.3) {
                triggerJumpscare();
            }

            // Collect Key
            if(!hasKey && camera.position.distanceTo(window.keyItem.position) < 1.5) {
                hasKey = true;
                window.keyItem.visible = false;
                document.getElementById('inventory').innerText = "KEY COLLECTED: ESCAPE THROUGH REAR DOOR!";
            }

            // Win Logic
            if(hasKey && camera.position.distanceTo(window.exitDoor.position) < 1.5) {
                alert("YOU ESCAPED THE BIKER HOUSE!");
                location.reload();
            }

            renderer.render(scene, camera);
        }

        function triggerJumpscare() {
            isGameOver = true;
            document.getElementById('jumpscare').style.display = 'block';
            // Play scream sound here if available
            setTimeout(() => { location.reload(); }, 3000);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>